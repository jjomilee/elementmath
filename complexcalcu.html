<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë³µì¡í•œ ì‚¬ì¹™ì—°ì‚° ì—°ìŠµ (ë‚œì´ë„ ì„¤ì •)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Comic Sans MS', 'Arial', sans-serif;
      background: linear-gradient(to bottom right, #d7fffe, #ffecd2);
      text-align: center;
      padding: 40px;
      color: #333;
    }

    h1 { font-size: 2em; margin-bottom: 16px; }

    .panel {
      display: inline-block;
      text-align: left;
      background: #ffffffee;
      padding: 16px 18px;
      border-radius: 12px;
      box-shadow: 0 0 10px #ccc;
      margin-bottom: 18px;
    }

    .panel h2 {
      margin: 0 0 10px;
      font-size: 1.1em;
      color: #444;
    }

    .row { display: flex; flex-wrap: wrap; gap: 10px 16px; align-items: center; }
    .row > label { font-size: .95em; }
    .row input[type="number"] { width: 90px; padding: 6px 8px; }
    .row input[type="checkbox"] { transform: translateY(1px); }
    .row .chip { padding: 6px 10px; background: #f4f6ff; border-radius: 10px; border: 1px solid #d9defa; }
    .divider { height: 8px; }

    .question { font-size: 2.1em; margin: 22px 0; color: #222; line-height: 1.25; }

    input.answer {
      font-size: 1.4em; width: 140px; text-align: center; padding: 10px;
      border-radius: 10px; border: 2px solid #aaa;
    }

    button {
      font-size: 1.05em; padding: 10px 18px; margin: 8px; border-radius: 12px;
      border: none; background-color: #7E57C2; color: white; cursor: pointer;
    }
    button:hover { background-color: #6a46b5; }
    button:disabled { background-color: #c5b4e5; cursor: not-allowed; }

    #result { font-size: 1.1em; margin-top: 16px; font-weight: bold; }

    #stats {
      margin-top: 24px; font-size: 1.02em; background: #ffffffcc; padding: 12px 20px;
      border-radius: 10px; display: inline-block; box-shadow: 0 0 8px #ccc;
    }

    #wrongList {
      margin-top: 22px; text-align: left; max-width: 560px; margin-left: auto; margin-right: auto;
      background: #fff8e6; padding: 14px; border-radius: 10px; box-shadow: 0 0 5px #ccc;
    }

    .wrong-item { font-size: 1em; margin: 5px 0; }

    .back { margin-top: 28px; display: inline-block; font-size: 1em; color: #0077cc; text-decoration: none; }
  </style>
</head>
<body>

  <h1>ğŸ§  ë³µì¡í•œ ì‚¬ì¹™ì—°ì‚° ì—°ìŠµ</h1>

  <!-- ì„¤ì • íŒ¨ë„ -->
  <div class="panel" id="settingsPanel">
    <h2>ë‚œì´ë„ ì„¤ì •</h2>
    <div class="row">
      <label class="chip">
        ë‚œì´ë„:
        <select id="levelSelect">
          <option value="easy">ì‰¬ì›€</option>
          <option value="normal" selected>ë³´í†µ</option>
          <option value="hard">ì–´ë ¤ì›€</option>
          <option value="custom">ì‚¬ìš©ì ì§€ì •</option>
        </select>
      </label>

      <label class="chip">ìµœì†Ÿê°’ <input type="number" id="minNum" value="10"></label>
      <label class="chip">ìµœëŒ“ê°’ <input type="number" id="maxNum" value="99"></label>

      <span class="chip">
        ì—°ì‚°ì:
        <label><input type="checkbox" id="opPlus" checked> +</label>
        <label><input type="checkbox" id="opMinus" checked> âˆ’</label>
        <label><input type="checkbox" id="opMul" checked> Ã—</label>
        <label><input type="checkbox" id="opDiv" checked> Ã·</label>
      </span>

      <span class="chip">
        í•­ ê°œìˆ˜:
        <label><input type="radio" name="terms" value="2" checked> 2ê°œ</label>
        <label><input type="radio" name="terms" value="3"> 3ê°œ</label>
      </span>

      <label class="chip"><input type="checkbox" id="useParen" checked> ê´„í˜¸ ì‚¬ìš©</label>
      <label class="chip"><input type="checkbox" id="intDiv" checked> ë‚˜ëˆ—ì…ˆì€ ì •ìˆ˜ ê²°ê³¼</label>

      <button id="applyBtn">ì„¤ì • ì ìš©</button>
      <button id="startBtn">ë¬¸ì œ ì‹œì‘/ì¬ì‹œì‘</button>
    </div>
    <div class="divider"></div>
    <small>â€» í”„ë¦¬ì…‹(ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€)ì„ ê³ ë¥´ë©´ ë²”ìœ„ì™€ ì˜µì…˜ì´ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤. â€œì‚¬ìš©ì ì§€ì •â€ìœ¼ë¡œ ë³€ê²½í•˜ë©´ ììœ ë¡­ê²Œ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”.</small>
  </div>

  <div class="question" id="question">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <input type="number" id="answerInput" class="answer" placeholder="ì •ë‹µ ì…ë ¥" inputmode="numeric" autocomplete="off">
  <div>
    <button id="submitBtn" onclick="checkAnswer()">ì œì¶œ</button>
    <button id="nextBtn" onclick="nextQuestion()">ë‹¤ìŒ ë¬¸ì œ</button>
  </div>

  <div id="result"></div>

  <div id="stats">
    <p>ì´ ë¬¸ì œ ìˆ˜: <span id="total">0</span></p>
    <p>ë§íŒ ë¬¸ì œ ìˆ˜: <span id="correct">0</span></p>
    <p>í‹€ë¦° ë¬¸ì œ ìˆ˜: <span id="wrong">0</span></p>
  </div>

  <div id="wrongList">
    <h3>âŒ ì˜¤ë‹µ ëª©ë¡</h3>
    <div id="wrongItems"><p>ì•„ì§ ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p></div>
  </div>

  <a href="index.html" class="back">ğŸ  ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

  <script>
    // ---------- ìƒíƒœ ----------
    let exprText = "", correctAnswer = 0;
    let total = 0, correct = 0, wrong = 0;
    let wrongProblems = [];
    let prevKey = "";
    let answered = false;

    // ì„¤ì • ìƒíƒœ
    const settings = {
      min: 10, max: 99,
      ops: { '+': true, '-': true, 'Ã—': true, 'Ã·': true },
      terms: 2,
      useParen: true,
      intDiv: true
    };

    // ---------- ìœ í‹¸ ----------
    const rint = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    function choice(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    // ì •ìˆ˜ ë‚˜ëˆ—ì…ˆ ë³´ì¥ìš©: (b,q) ë½‘ì•„ a=b*q ìƒì„±
    function makeDivision(min, max) {
      const b = rint(2, Math.max(2, Math.min(12, max))); // ì‘ì€ ë²”ìœ„ì—ì„œ ë‚˜ëˆ—ìˆ˜
      const q = rint(2, Math.max(2, Math.min(12, Math.floor(max / Math.max(2, b)))));
      const a = b * q;
      if (a < min || a > max) return makeDivision(min, max); // ì¬ê·€ë¡œ ë²”ìœ„ ë§ì¶”ê¸°
      return { a, b, q };
    }

    // ê´„í˜¸ê°€ ìˆì„ ë•Œ ë³´ê¸° ì¢‹ì€ í…œí”Œë¦¿ ëª¨ìŒ(ì •ìˆ˜ Ã· ë³´ì¥)
    function templatesWithParen(min, max, ops, intDiv) {
      const list = [];

      if (ops['+'] && ops['Ã—']) {
        list.push(() => {
          const a = rint(min, max), b = rint(min, max), c = rint(2, Math.min(12, Math.floor(max / 2)));
          return { text: `(${a} + ${b}) Ã— ${c}`, value: (a + b) * c };
        });
      }
      if (ops['-'] && ops['Ã—']) {
        list.push(() => {
          let a = rint(min, max), b = rint(min, max); if (b > a) [a,b]=[b,a];
          const c = rint(2, Math.min(12, Math.floor(max / 2)));
          return { text: `(${a} - ${b}) Ã— ${c}`, value: (a - b) * c };
        });
      }
      if (ops['Ã—'] && ops['Ã·'] && intDiv) {
        list.push(() => {
          const a = rint(2, Math.min(12, max)), b = rint(2, Math.min(12, max));
          const prod = a * b;
          const { b: c } = makeDivision(2, Math.min(12, prod)); // cëŠ” prodì˜ ì•½ìˆ˜ ë²”ìœ„ì—ì„œ
          return { text: `(${a} Ã— ${b}) Ã· ${c}`, value: Math.floor(prod / c) };
        });
      }
      if (ops['+'] && ops['Ã·'] && intDiv) {
        list.push(() => {
          const a = rint(min, max), b = rint(min, max);
          const sum = a + b;
          // sumì˜ ì•½ìˆ˜ ì¤‘ 2~12
          let divisors = [];
          for (let d = 2; d <= 12; d++) if (sum % d === 0) divisors.push(d);
          if (divisors.length === 0) { // ëª» ì°¾ìœ¼ë©´ ë‹¤ì‹œ ë§Œë“¤ê¸°
            const c = 2; return { text: `(${a} + ${b}) Ã· ${c}`, value: Math.floor(sum / c) };
          }
          const c = choice(divisors);
          return { text: `(${a} + ${b}) Ã· ${c}`, value: sum / c };
        });
      }
      if (ops['-'] && ops['Ã·'] && intDiv) {
        list.push(() => {
          let a = rint(min, max), b = rint(min, max); if (b > a) [a,b]=[b,a];
          let diff = a - b;
          if (diff === 0) { a += 1; diff = 1; }
          // diffì˜ ì•½ìˆ˜(2~12) ì°¾ê¸°
          let candidates = [];
          for (let d = 2; d <= 12; d++) if (diff % d === 0) candidates.push(d);
          if (candidates.length === 0) {
            const { a: A, b: B, q } = makeDivision(2, 144);
            const newDiff = B * q;
            const newA = newDiff + b;
            return { text: `(${newA} - ${b}) Ã· ${B}`, value: q };
          }
          const c = choice(candidates);
          return { text: `(${a} - ${b}) Ã· ${c}`, value: diff / c };
        });
      }

      return list;
    }

    // ê´„í˜¸ ì—†ì´ 2í•­/3í•­ ìƒì„±(Ã·ëŠ” intDivë©´ ì •ìˆ˜ ë³´ì¥)
    function makeLinearExpr(min, max, ops, terms, intDiv) {
      const allowedOps = Object.keys(ops).filter(k => ops[k]);
      if (allowedOps.length === 0) allowedOps.push('+');

      const nums = [];
      const opsPicked = [];

      // ìµœì†Œ í•˜ë‚˜ëŠ” ìˆ«ì ìƒì„±
      function randNumber() { return rint(min, max); }

      if (terms === 2) {
        let op = choice(allowedOps);
        let a = randNumber(), b = randNumber();
        if (op === 'âˆ’' || op === '-') { op = 'âˆ’'; if (b > a) [a,b]=[b,a]; }
        if ((op === 'Ã·' || op === '/') && intDiv) {
          const made = makeDivision(2, Math.max(12, Math.min(99, max)));
          // ìŠ¤ì¼€ì¼ ì¡°ì •
          a = made.a; b = made.b; op = 'Ã·';
        }
        const text = `${a} ${opMap(op)} ${b}`;
        const value = evalValue(a, op, b);
        return { text, value };
      } else {
        // 3í•­
        // í˜•íƒœ: a op1 b op2 c (ìš°ì„ ìˆœìœ„ëŠ” Ã—, Ã· ìš°ì„ )
        let a = randNumber(), b = randNumber(), c = randNumber();
        let op1 = choice(allowedOps), op2 = choice(allowedOps);

        // ìŒìˆ˜ ë°©ì§€
        if ((op1 === 'âˆ’' || op1 === '-') && b > a) [a,b]=[b,a];
        if ((op2 === 'âˆ’' || op2 === '-') && c > b && !(['Ã—','Ã·','*','/'].includes(op1))) [b,c]=[c,b];

        // Ã· ì •ìˆ˜ ë³´ì¥(ê°€ëŠ¥í•œ ê²½ìš°)
        if ((op1 === 'Ã·' || op1 === '/') && intDiv) { const m = makeDivision(2, 99); a = m.a; b = m.b; op1 = 'Ã·'; }
        if ((op2 === 'Ã·' || op2 === '/') && intDiv) { const m = makeDivision(2, 99); b = m.a; c = m.b; op2 = 'Ã·'; }

        const text = `${a} ${opMap(op1)} ${b} ${opMap(op2)} ${c}`;
        const value = evalThree(a, op1, b, op2, c);
        return { text, value };
      }
    }

    // ê¸°í˜¸ ì •ê·œí™”
    function opMap(op) {
      if (op === '-') return 'âˆ’';
      if (op === '*') return 'Ã—';
      if (op === '/') return 'Ã·';
      return op;
    }

    // 2í•­ í‰ê°€
    function evalValue(a, op, b) {
      if (op === '+' ) return a + b;
      if (op === 'âˆ’' || op === '-') return a - b;
      if (op === 'Ã—' || op === '*') return a * b;
      if (op === 'Ã·' || op === '/') return Math.floor(a / b);
      return a + b;
    }

    // 3í•­ ìš°ì„ ìˆœìœ„ í‰ê°€(Ã—, Ã· ìš°ì„ )
    function evalThree(a, op1, b, op2, c) {
      const muldiv = (op) => (op === 'Ã—' || op === '*' || op === 'Ã·' || op === '/');
      if (muldiv(op1)) {
        const first = evalValue(a, op1, b);
        return evalValue(first, op2, c);
      } else if (muldiv(op2)) {
        const second = evalValue(b, op2, c);
        return evalValue(a, op1, second);
      } else {
        return evalValue(evalValue(a, op1, b), op2, c);
      }
    }

    // ---------- ë¬¸ì œ ìƒì„± ----------
    function createProblem() {
      const ops = settings.ops;
      const min = settings.min, max = settings.max;
      let prob;

      const useParen = settings.useParen;
      const terms = settings.terms;
      const intDiv = settings.intDiv;

      let tries = 0;
      do {
        tries++;
        if (useParen) {
          const candidates = templatesWithParen(min, max, ops, intDiv);
          if (candidates.length > 0 && Math.random() < 0.7) {
            const maker = choice(candidates);
            prob = maker();
          } else {
            prob = makeLinearExpr(min, max, ops, terms, intDiv);
          }
        } else {
          prob = makeLinearExpr(min, max, ops, terms, intDiv);
        }
        if (tries > 30) break; // ì•ˆì „ì¥ì¹˜
      } while (prob.text === prevKey);

      prevKey = prob.text;
      return prob;
    }

    // ---------- UI ë™ì‘ ----------
    function nextQuestion() {
      const p = createProblem();
      exprText = p.text;
      correctAnswer = p.value;
      answered = false;

      document.getElementById("question").innerText = `${exprText} = ?`;
      const input = document.getElementById("answerInput");
      input.value = '';
      input.focus();
      document.getElementById("result").innerText = '';
      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled = false;
      submitBtn.textContent = 'ì œì¶œ';
    }

    function updateStats() {
      document.getElementById("total").innerText = total;
      document.getElementById("correct").innerText = correct;
      document.getElementById("wrong").innerText = wrong;
    }

    function updateWrongList() {
      const container = document.getElementById("wrongItems");
      if (wrongProblems.length === 0) {
        container.innerHTML = "<p>ì•„ì§ ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }
      container.innerHTML = "";
      wrongProblems.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "wrong-item";
        div.innerText = `${index + 1}. ${item.problem} â†’ ë‚´ ë‹µ: ${item.user}, ì •ë‹µ: ${item.correct}`;
        container.appendChild(div);
      });
    }

    function checkAnswer() {
      if (answered) return;
      const inputEl = document.getElementById("answerInput");
      const userInput = parseInt(inputEl.value, 10);
      const submitBtn = document.getElementById("submitBtn");

      if (isNaN(userInput)) {
        document.getElementById("result").innerText = "âš ï¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        inputEl.focus();
        return;
      }

      submitBtn.disabled = true;
      total++;

      if (userInput === correctAnswer) {
        correct++;
        document.getElementById("result").innerText =
          "âœ… ì •ë‹µì´ì—ìš”! ì˜í–ˆì–´ìš”! (Enterë¥¼ ëˆ„ë¥´ë©´ ë‹¤ìŒ ë¬¸ì œ)";
      } else {
        wrong++;
        wrongProblems.push({ problem: exprText, user: userInput, correct: correctAnswer });
        document.getElementById("result").innerText =
          `âŒ ì˜¤ë‹µì´ì—ìš”. ì •ë‹µì€ ${correctAnswer}ì…ë‹ˆë‹¤. (Enterë¥¼ ëˆ„ë¥´ë©´ ë‹¤ìŒ ë¬¸ì œ)`;
      }

      answered = true;
      submitBtn.textContent = 'ì±„ì  ì™„ë£Œ';
      updateStats();
      updateWrongList();
    }

    // Enter: ì±„ì  ì „ â†’ ì œì¶œ, ì±„ì  í›„ â†’ ë‹¤ìŒ ë¬¸ì œ
    const answerInput = document.getElementById("answerInput");
    answerInput.addEventListener("keydown", (e) => {
      if (e.isComposing) return;
      if (e.key === "Enter") {
        if (answered) nextQuestion();
        else checkAnswer();
      }
    });

    // ---------- ë‚œì´ë„ í”„ë¦¬ì…‹ ----------
    const levelSelect = document.getElementById('levelSelect');
    const minNum = document.getElementById('minNum');
    const maxNum = document.getElementById('maxNum');
    const opPlus = document.getElementById('opPlus');
    const opMinus = document.getElementById('opMinus');
    const opMul = document.getElementById('opMul');
    const opDiv = document.getElementById('opDiv');
    const useParenChk = document.getElementById('useParen');
    const intDivChk = document.getElementById('intDiv');
    const applyBtn = document.getElementById('applyBtn');
    const startBtn = document.getElementById('startBtn');

    function applyPreset() {
      const lv = levelSelect.value;
      if (lv === 'easy') {
        minNum.value = 1;  maxNum.value = 20;
        opPlus.checked = true; opMinus.checked = true; opMul.checked = false; opDiv.checked = false;
        document.querySelector('input[name="terms"][value="2"]').checked = true;
        useParenChk.checked = false; intDivChk.checked = true;
      } else if (lv === 'normal') {
        minNum.value = 5;  maxNum.value = 50;
        opPlus.checked = true; opMinus.checked = true; opMul.checked = true; opDiv.checked = true;
        document.querySelector('input[name="terms"][value="2"]').checked = true;
        useParenChk.checked = true; intDivChk.checked = true;
      } else if (lv === 'hard') {
        minNum.value = 10; maxNum.value = 99;
        opPlus.checked = true; opMinus.checked = true; opMul.checked = true; opDiv.checked = true;
        document.querySelector('input[name="terms"][value="3"]').checked = true;
        useParenChk.checked = true; intDivChk.checked = true;
      } else {
        // ì‚¬ìš©ì ì§€ì •: ê¸°ì¡´ ê°’ ìœ ì§€
      }
    }

    levelSelect.addEventListener('change', applyPreset);

    function readSettings() {
      settings.min = parseInt(minNum.value, 10);
      settings.max = parseInt(maxNum.value, 10);
      // ì•ˆì „ ë³´ì •
      if (isNaN(settings.min)) settings.min = 1;
      if (isNaN(settings.max) || settings.max < settings.min) settings.max = Math.max(9, settings.min + 9);

      settings.ops['+'] = opPlus.checked;
      settings.ops['âˆ’'] = opMinus.checked; // ë‚´ë¶€ í‘œê¸°
      settings.ops['Ã—'] = opMul.checked;
      settings.ops['Ã·'] = opDiv.checked;

      settings.terms = parseInt(document.querySelector('input[name="terms"]:checked').value, 10);
      settings.useParen = useParenChk.checked;
      settings.intDiv = intDivChk.checked;
    }

    applyBtn.addEventListener('click', () => {
      readSettings();
      alert('ì„¤ì •ì„ ì ìš©í–ˆì–´ìš”! (ë‹¤ìŒ ë¬¸ì œë¶€í„° ë°˜ì˜ë©ë‹ˆë‹¤)');
    });

    startBtn.addEventListener('click', () => {
      readSettings();
      // í†µê³„ ì´ˆê¸°í™”(ì›í•˜ì‹œë©´ ì œê±° ê°€ëŠ¥)
      total = 0; correct = 0; wrong = 0; wrongProblems = []; prevKey = ""; answered = false;
      updateStats();
      updateWrongList();
      nextQuestion();
    });

    // ì´ˆê¸° êµ¬ë™
    applyPreset(); // ê¸°ë³¸: ë³´í†µ
    nextQuestion();
    updateStats();
    updateWrongList();
  </script>
</body>
</html>
